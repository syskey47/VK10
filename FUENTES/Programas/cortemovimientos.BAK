SET STEP ON 

LOCAL lnAno

SELECT 0
USE CTB_DOCUMENTOSH 

SELECT 0
USE CTB_DIARIOH

SELECT 0
USE CTB_DOCUMENTOS

SELECT MAX(YEAR(CTB_DOCUMENTOS.Fecha)) AS Ano ;
	FROM CTB_DOCUMENTOS ;
	INTO CURSOR curAnos
	
IF	_TALLY > 0

	lnAno = curAnos.Ano

	UPDATE CTB_DOCUMENTOS ;
		SET CTB_DOCUMENTOS.Vigente = .F.
	
	UPDATE CTB_DOCUMENTOS ;
		SET CTB_DOCUMENTOS.Vigente = .T. ;
		WHERE YEAR(CTB_DOCUMENTOS.Fecha) = lnAno OR ;
			(CTB_DOCUMENTOS.ValorDocumentoCXC > 0 AND ;
				CTB_DOCUMENTOS.SaldoDocumentoCXC > 0)

	SELECT 0
	USE CTB_DIARIO

	UPDATE CTB_DIARIO ;
		SET CTB_DIARIO.GeneraComision = .F.
	
	UPDATE CTB_DIARIO ;
		SET CTB_DIARIO.GeneraComision = .T. ;
		WHERE CTB_DIARIO.IdDocumento IN ;
			(SELECT CTB_DOCUMENTOS.Id ;
				FROM CTB_DOCUMENTOS ;
				WHERE CTB_DOCUMENTOS.Vigente = .T. )

	*!*	SE ACTUALIZAND DOCUMENTOS HIJOS				
	SELECT DISTINCT CTB_DOCUMENTOS.Id ;
		FROM CTB_DIARIO ;
			INNER JOIN CTB_DOCUMENTOS ;
				ON CTB_DIARIO.IdDocumento = CTB_DOCUMENTOS.Id ;
		WHERE CTB_DIARIO.IdDocumentoPadre IN ;
			(SELECT CTB_DOCUMENTOS.Id ;
				FROM CTB_DOCUMENTOS ;
				WHERE CTB_DOCUMENTOS.Vigente = .T. ) ;
		INTO CURSOR curDOCS
				
	UPDATE CTB_DOCUMENTOS ;
		SET CTB_DOCUMENTOS.Vigente = .T. ;
		WHERE CTB_DOCUMENTOS.Id IN ;
			(SELECT curDOCS.Id ;
				FROM curDOCS) ;

	UPDATE CTB_DIARIO ;
		SET CTB_DIARIO.GeneraComision = .T. ;
		WHERE CTB_DIARIO.IdDocumento IN ;
			(SELECT curDOCS.Id ;
				FROM curDOCS) ;
				
	USE IN ('curDOCS')
				
	SELECT * ;
		FROM CTB_DOCUMENTOS ;
		WHERE CTB_DOCUMENTOS.Vigente = .F. ;
		INTO CURSOR curDOCUMENTOS
		
	SELECT * ;
		FROM CTB_DIARIO ;
		WHERE CTB_DIARIO.GeneraComision = .F. ;
		INTO CURSOR curDIARIO
			
	SELECT CTB_DIARIOH 
		
	APPEND FROM DBF('curDIARIO')
	
	USE IN ('curDIARIO')
	
	SELECT CTB_DOCUMENTOSH
		
	APPEND FROM DBF('curDOCUMENTOS')
	
	USE IN ('curDOCUMENTOS')
		
	SELECT CTB_DIARIO
		
	DELETE FROM CTB_DIARIO ;
		WHERE CTB_DIARIO.GeneraComision = .F.

	DELETE FROM CTB_DOCUMENTOS ;
		WHERE CTB_DOCUMENTOS.Vigente = .F.
		
ENDIF

CLOSE TABLES ALL
